<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>BilimDos - –û“õ—É –∫”©–º–µ–∫—à—ñ—Å—ñ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8fafc; /* Very light slate */
            /* Background pattern for texture */
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Markdown Styles within Chat Bubbles */
        .prose p { margin-bottom: 0.5em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.5em; }
        .prose strong { font-weight: 700; }
        .prose code { background: rgba(255,255,255,0.2); padding: 2px 4px; border-radius: 4px; font-size: 0.9em; font-family: monospace; }
        .prose-sky code { background: rgba(0,0,0,0.05); color: #0369a1; }
        
        /* Hide scrollbar for textarea but keep functionality */
        textarea {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        textarea::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 selection:bg-sky-200">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md border-b border-sky-100 px-4 py-3 flex items-center justify-between sticky top-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-sky-400 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-sky-200 transform hover:scale-105 transition-transform">
                <i data-lucide="graduation-cap" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-extrabold text-xl leading-none text-slate-800 tracking-tight">BilimDos</h1>
                <span class="text-[10px] font-bold text-sky-500 uppercase tracking-widest">–û“õ—É –∫”©–º–µ–∫—à—ñ—Å—ñ</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="window.location.reload()" class="p-2 text-slate-400 hover:text-sky-500 hover:bg-sky-50 rounded-full transition-all active:rotate-180 duration-500" title="–ñ–∞“£–∞—Ä—Ç—É">
                <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Chat Container -->
    <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-6 pb-40 scroll-smooth">
        
        <!-- Welcome Message -->
        <div class="flex w-full justify-start fade-in">
            <div class="flex max-w-[90%] md:max-w-[75%] gap-3">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-sky-400 to-blue-600 flex items-center justify-center text-white shrink-0 shadow-md mt-1 border-2 border-white">
                    <i data-lucide="bot" class="w-5 h-5"></i>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-slate-400 ml-1 font-semibold">BilimDos</span>
                    <div class="bg-white border border-sky-50 p-5 rounded-2xl rounded-tl-none shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] text-slate-700">
                        <p class="font-bold text-lg text-slate-800 mb-2">–°”ô–ª–µ–º! üëã –ú–µ–Ω BilimDos-–ø—ã–Ω.</p>
                        <p class="mb-3 leading-relaxed">–ú–µ–Ω —Å–∞“ì–∞–Ω —Å–∞–±–∞“õ –æ“õ—É“ì–∞, “Ø–π —Ç–∞–ø—Å—ã—Ä–º–∞—Å—ã–Ω –æ—Ä—ã–Ω–¥–∞—É“ì–∞ –∂”ô–Ω–µ —Å“±—Ä–∞“õ—Ç–∞—Ä—ã“£–∞ –∂–∞—É–∞–ø –±–µ—Ä—É–≥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.</p>
                        <p class="mb-3 leading-relaxed">–ú–∞“ì–∞–Ω "–ê–ª–º–∞–Ω—ã“£ —Å—É—Ä–µ—Ç—ñ–Ω —Å–∞–ª" –¥–µ–ø –∞–π—Ç—Å–∞“£, –º–µ–Ω —Å—É—Ä–µ—Ç —Å–∞–ª—ã–ø –±–µ—Ä–µ –∞–ª–∞–º—ã–Ω! üé®</p>
                        <div class="flex flex-wrap gap-2 text-xs font-bold text-sky-600">
                            <span class="bg-sky-50 px-2 py-1 rounded-md border border-sky-100">üá∞üáø “ö–∞–∑–∞“õ—à–∞</span>
                            <span class="bg-sky-50 px-2 py-1 rounded-md border border-sky-100">üá∑üá∫ –†—É—Å—Å–∫–∏–π</span>
                            <span class="bg-sky-50 px-2 py-1 rounded-md border border-sky-100">üá¨üáß English</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Floating Loading Indicator -->
    <div id="loader" class="hidden absolute bottom-32 left-0 w-full flex justify-center z-10 pointer-events-none transition-opacity duration-300">
        <div class="bg-white/90 backdrop-blur-md border border-sky-100 pl-3 pr-4 py-2 rounded-full shadow-lg flex items-center gap-2.5 animate-bounce-slight">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-sky-500 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-sky-500 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-sky-500 rounded-full typing-dot"></div>
            </div>
            <span id="loader-text" class="text-xs font-bold text-sky-600 uppercase tracking-wide">–ñ–∞—É–∞–ø –∂–∞–∑—ã–ª—É–¥–∞...</span>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="input-gallery" accept="image/*" class="hidden" onchange="handleFile(this)">
    <input type="file" id="input-camera" accept="image/*" capture="environment" class="hidden" onchange="handleFile(this)">

    <!-- Modern Floating Input Footer -->
    <footer class="fixed bottom-0 w-full z-30 p-2 md:p-6 pointer-events-none flex justify-center">
        
        <!-- Input Container (Pointer events auto to allow interaction) -->
        <div class="w-full max-w-4xl pointer-events-auto flex flex-col gap-2 relative">

            <!-- Absolute Float Area (For Preview & Menus) -->
            <div class="absolute bottom-full left-0 w-full mb-2 flex flex-col items-start gap-2 px-1">
                
                <!-- Media Preview -->
                <div id="media-preview" class="hidden items-center gap-3 bg-white/95 backdrop-blur shadow-xl p-2 rounded-2xl border border-sky-100 animate-in slide-in-from-bottom-5 fade-in duration-300">
                    <div class="relative group">
                        <img id="preview-img" class="h-16 w-16 object-cover rounded-xl border border-sky-100 hidden">
                        <div id="preview-audio" class="h-16 w-16 bg-gradient-to-br from-sky-100 to-sky-200 rounded-xl flex items-center justify-center text-sky-600 hidden">
                            <i data-lucide="mic" class="w-6 h-6"></i>
                        </div>
                        <button onclick="clearMedia()" class="absolute -top-2 -right-2 bg-white text-red-500 rounded-full p-1 shadow-md border border-red-100 hover:bg-red-50 hover:scale-110 transition-all">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="flex flex-col pr-3">
                        <span id="media-type-label" class="text-xs font-bold text-slate-700 uppercase tracking-wider">–§–∞–π–ª</span>
                        <span class="text-[10px] text-sky-500 font-medium bg-sky-50 px-1.5 py-0.5 rounded mt-1 w-fit">–ñ—ñ–±–µ—Ä—É–≥–µ –¥–∞–π—ã–Ω</span>
                    </div>
                </div>

                <!-- Media Choice Menu -->
                <div id="media-choice-menu" class="hidden bg-white/95 backdrop-blur border border-slate-200 shadow-2xl rounded-2xl p-1.5 flex flex-col gap-1 min-w-[160px] animate-in slide-in-from-bottom-5 zoom-in-95 duration-200 origin-bottom-left">
                    <div class="text-[10px] font-bold text-slate-400 uppercase px-3 py-1.5 tracking-wider">–§–∞–π–ª —Ç“Ø—Ä—ñ</div>
                    <button onclick="triggerInput('camera')" class="flex items-center gap-3 px-3 py-2.5 hover:bg-sky-50 rounded-xl text-slate-700 hover:text-sky-600 text-left transition-all group">
                        <div class="bg-sky-100 p-2 rounded-lg group-hover:bg-sky-200 transition-colors"><i data-lucide="camera" class="w-4 h-4 text-sky-600"></i></div>
                        <span class="text-sm font-bold">–ö–∞–º–µ—Ä–∞</span>
                    </button>
                    <button onclick="triggerInput('gallery')" class="flex items-center gap-3 px-3 py-2.5 hover:bg-sky-50 rounded-xl text-slate-700 hover:text-sky-600 text-left transition-all group">
                        <div class="bg-purple-100 p-2 rounded-lg group-hover:bg-purple-200 transition-colors"><i data-lucide="image" class="w-4 h-4 text-purple-600"></i></div>
                        <span class="text-sm font-bold">–ì–∞–ª–µ—Ä–µ—è</span>
                    </button>
                </div>

                <!-- Recording Status -->
                <div id="recording-status" class="hidden w-full md:w-auto items-center justify-between bg-white/95 backdrop-blur border border-red-100 shadow-xl p-2 pl-4 rounded-2xl animate-in slide-in-from-bottom-5">
                    <div class="flex items-center gap-3 text-red-500">
                        <div class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                        </div>
                        <span class="font-bold text-sm tracking-wide">–ñ–∞–∑—ã–ª—É–¥–∞...</span>
                        <span id="recording-time" class="font-mono text-sm bg-red-50 text-red-600 px-2 py-0.5 rounded border border-red-100 min-w-[3rem] text-center">0:00</span>
                    </div>
                    <button onclick="stopRecording()" class="ml-4 bg-red-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md shadow-red-200 hover:bg-red-600 hover:scale-105 active:scale-95 transition-all uppercase tracking-wide">
                        –¢–æ“õ—Ç–∞—Ç—É
                    </button>
                </div>
            </div>

            <!-- Main Input Bar -->
            <div id="input-controls" class="w-full bg-white border border-slate-200 shadow-[0_8px_30px_rgb(0,0,0,0.06)] rounded-[2rem] p-1.5 flex items-end gap-1.5 transition-all duration-300 ring-4 ring-transparent focus-within:ring-sky-100 focus-within:border-sky-300">
                
                <!-- Tools Group (Pill) -->
                <div class="flex items-center gap-0.5 bg-slate-50 border border-slate-100 rounded-[1.5rem] p-1 h-[48px] shrink-0">
                    <button id="media-btn-trigger" onclick="toggleMediaMenu()" class="w-10 h-10 rounded-full bg-transparent text-slate-400 hover:bg-white hover:text-sky-600 hover:shadow-sm active:scale-90 transition-all flex items-center justify-center group relative" title="–°—É—Ä–µ—Ç –∂“Ø–∫—Ç–µ—É">
                        <i data-lucide="camera" class="w-5 h-5 transition-transform group-hover:-rotate-12"></i>
                    </button>
                    <div class="w-px h-5 bg-slate-200"></div>
                    <button id="mic-btn" onclick="startRecording()" class="w-10 h-10 rounded-full bg-transparent text-slate-400 hover:bg-white hover:text-red-500 hover:shadow-sm active:scale-90 transition-all flex items-center justify-center group" title="–î—ã–±—ã—Å –∂–∞–∑—É">
                        <i data-lucide="mic" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    </button>
                </div>

                <!-- Text Input -->
                <div class="flex-1 min-h-[48px] flex items-center px-2 py-1">
                    <textarea 
                        id="user-input"
                        rows="1" 
                        class="w-full bg-transparent border-none outline-none text-slate-800 placeholder-slate-400 resize-none max-h-32 py-2 leading-relaxed text-base"
                        placeholder="–•–∞–±–∞—Ä–ª–∞–º–∞ –∂–∞–∑—É..."
                        oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                    ></textarea>
                </div>

                <!-- Send Button -->
                <button id="send-btn" onclick="sendMessage()" class="w-12 h-12 rounded-full bg-gradient-to-tr from-sky-500 to-blue-600 text-white shadow-lg shadow-sky-200 flex items-center justify-center hover:scale-105 active:scale-90 disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed transition-all shrink-0 mb-0">
                    <i data-lucide="arrow-up" class="w-6 h-6 stroke-[3]"></i>
                </button>
            </div>
            
        </div>
    </footer>

    <!-- Configuration Script -->
    <script>
        // --- PHP & HOSTING CONFIGURATION ---
        // If you rename this file to .php, you can inject the API key securely from the server.
        // Example PHP code: <script> window.PHP_API_KEY = "<?php echo getenv('API_KEY'); ?>"; <\/script>
        
        // This shim mimics the NodeJS process.env for compatibility with the Gemini SDK logic.
        // TODO: Replace 'YOUR_VALID_API_KEY_HERE' with a valid Google Gemini API Key.
        window.process = { env: { API_KEY: '-' } };
        
        // 1. Try to get key from global variable (PHP injection point)
        if (typeof window.PHP_API_KEY !== 'undefined' && window.PHP_API_KEY) {
            window.process.env.API_KEY = window.PHP_API_KEY;
        } 
        
        // Debug check (remove in production if sensitive)
        if (!window.process.env.API_KEY) {
            console.warn("BilimDos: API Key is missing. Please set process.env.API_KEY or window.PHP_API_KEY.");
        }
    </script>

    <!-- Application Logic -->
    <script type="module">
        import { GoogleGenAI, Type } from "https://esm.run/@google/genai";

        // --- CONSTANTS ---
        const API_KEY = process.env.API_KEY;
        const MODEL_NAME = "gemini-2.5-flash"; 
        const IMAGE_MODEL_NAME = "gemini-2.5-flash-image";

        const SYSTEM_INSTRUCTION = `
You are BilimDos, an intelligent and friendly educational assistant for school students.
Your primary interface language is Kazakh (“ö–∞–∑–∞“õ —Ç—ñ–ª—ñ).

CORE INSTRUCTIONS:
1.  **Language Mirroring**: STRICTLY detect the language of the user's latest message (Kazakh, Russian, or English) and respond in that EXACT same language. Do not switch unless asked.
2.  **Role**: You are a supportive tutor. Be polite, patient, and clear.
3.  **Identity & Creator**:
    - If asked "Who created you?", "–°–µ–Ω—ñ –∫—ñ–º –∂–∞—Å–∞–¥—ã?", "–ö—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª?" or similar questions, ALWAYS answer that you were created by **–ú–∞—Ä–∂–∞–Ω –î”ô–∫–µ–Ω“õ—ã–∑—ã** (Marzhan Dakenkyzy).
    - Provide this answer in the same language as the question (Kazakh, Russian, or English).
4.  **Capabilities**:
    -   Explain school subjects (Math, Science, History, Language).
    -   Analyze images (e.g., "Explain this diagram").
    -   Transcribe and answer audio messages.
    -   **Image Generation**: You CAN generate images. If the user asks to "draw", "paint", or "create an image" of something (e.g., "draw an apple", "–∞–ª–º–∞–Ω—ã“£ —Å—É—Ä–µ—Ç—ñ–Ω —Å–∞–ª"), you must call the \`generate_image\` tool.
5.  **Audio Handling**: If the input is audio, first explicitly transcribe what you heard starting with "üó£Ô∏è:", then provide your helpful answer.

Formatting:
-   Use Markdown for clarity (bold keywords, lists).
-   Keep responses visually clean.
`;

        // --- TOOLS DEFINITION ---
        const imageGenerationTool = {
            functionDeclarations: [{
                name: "generate_image",
                description: "Generates an image based on a prompt. Use this ONLY when the user explicitly asks to draw, create, or generate a picture/image.",
                parameters: {
                    type: Type.OBJECT,
                    properties: {
                        prompt: {
                            type: Type.STRING,
                            description: "A highly detailed visual description of the image to generate in English."
                        }
                    },
                    required: ["prompt"]
                }
            }]
        };

        // --- STATE ---
        let ai = null;
        let chat = null;
        let currentMedia = null; // { type: 'image'|'audio', data: base64, mimeType: string, url: string }
        let mediaRecorder = null;
        let recordingInterval = null;
        let isProcessing = false;

        // --- INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            
            if (!API_KEY) {
                appendSystemMessage("‚ö†Ô∏è <b>API Key —Ç–∞–±—ã–ª–º–∞–¥—ã.</b><br>Please configure the API Key in the code or server environment.");
                document.getElementById('send-btn').disabled = true;
                return;
            }

            try {
                ai = new GoogleGenAI({ apiKey: API_KEY });
                initChat();
            } catch (error) {
                console.error("AI Init Error:", error);
                appendSystemMessage("‚ö†Ô∏è AI –∂“Ø–π–µ—Å—ñ–Ω —ñ—Å–∫–µ “õ–æ—Å—É “õ–∞—Ç–µ—Å—ñ.");
            }
        };

        function initChat() {
            chat = ai.chats.create({
                model: MODEL_NAME,
                config: { 
                    systemInstruction: SYSTEM_INSTRUCTION,
                    temperature: 0.7,
                    tools: [imageGenerationTool]
                }
            });
        }

        // --- UI FUNCTIONS ---
        window.toggleMediaMenu = function() {
            const menu = document.getElementById('media-choice-menu');
            menu.classList.toggle('hidden');
        };

        window.triggerInput = function(type) {
            document.getElementById('media-choice-menu').classList.add('hidden');
            if (type === 'camera') {
                document.getElementById('input-camera').click();
            } else {
                document.getElementById('input-gallery').click();
            }
        };

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('media-choice-menu');
            const btn = document.getElementById('media-btn-trigger');
            if (!menu || !btn) return;
            if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        function setLoaderText(text) {
            document.getElementById('loader-text').innerText = text;
        }

        function appendSystemMessage(html) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = "flex w-full justify-center fade-in py-2";
            div.innerHTML = `<div class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm text-center border border-red-100 shadow-sm">${html}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function appendMessage(role, text, media = null, isGenerated = false) {
            const chatBox = document.getElementById('chat-box');
            const isUser = role === 'user';
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} fade-in`;
            
            const content = document.createElement('div');
            content.className = `flex max-w-[90%] md:max-w-[75%] gap-3 ${isUser ? 'flex-row-reverse' : ''}`;
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = `w-9 h-9 rounded-full flex items-center justify-center text-white shrink-0 shadow-sm mt-auto border-2 border-white ${isUser ? 'bg-indigo-500' : 'bg-gradient-to-br from-sky-400 to-blue-600'}`;
            avatar.innerHTML = isUser 
                ? '<i data-lucide="user" class="w-5 h-5"></i>'
                : '<i data-lucide="bot" class="w-5 h-5"></i>';

            // Message Bubble
            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = "flex flex-col gap-1 min-w-0";
            
            // Name Label
            const nameLabel = document.createElement('span');
            nameLabel.className = `text-[11px] font-bold text-slate-400 uppercase tracking-wide ${isUser ? 'text-right mr-2' : 'ml-2'}`;
            nameLabel.innerText = isUser ? "–°—ñ–∑" : "BilimDos";
            
            const bubble = document.createElement('div');
            bubble.className = `p-3.5 md:p-4 rounded-[1.2rem] shadow-sm text-sm md:text-base break-words overflow-hidden leading-relaxed ${
                isUser 
                ? 'bg-indigo-500 text-white rounded-br-sm' 
                : 'bg-white border border-sky-50 rounded-bl-sm text-slate-700 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)]'
            }`;
            
            // Media Content (Uploaded or Generated)
            if (media) {
                const mediaDiv = document.createElement('div');
                mediaDiv.className = "mb-3 rounded-xl overflow-hidden border border-white/20 shadow-sm";
                
                if (media.type === 'image') {
                    mediaDiv.innerHTML = `
                        <img src="${media.url}" class="max-w-full max-h-80 object-cover block w-full bg-slate-100">
                        ${isGenerated ? '<div class="text-[10px] text-slate-400 text-center py-1 italic">AI “õ“±—Ä–∞—Å—Ç—ã—Ä“ì–∞–Ω —Å—É—Ä–µ—Ç</div>' : ''}
                    `;
                } else if (media.type === 'audio') {
                    mediaDiv.innerHTML = `
                        <div class="flex items-center gap-3 bg-black/10 p-3 rounded backdrop-blur-md">
                            <div class="p-2 bg-white/20 rounded-full"><i data-lucide="music" class="w-5 h-5 text-white"></i></div>
                            <span class="text-xs font-bold font-mono text-white/90">AUDIO</span>
                        </div>
                        <audio controls src="${media.url}" class="w-full mt-2 h-8 opacity-90"></audio>`;
                }
                bubble.appendChild(mediaDiv);
            }

            // Text Content
            if (text) {
                const textDiv = document.createElement('div');
                textDiv.className = `prose ${isUser ? 'prose-invert' : 'prose-sky'} max-w-none leading-relaxed`;
                textDiv.innerHTML = marked.parse(text);
                bubble.appendChild(textDiv);
            }

            bubbleContainer.appendChild(nameLabel);
            bubbleContainer.appendChild(bubble);
            
            content.appendChild(avatar);
            content.appendChild(bubbleContainer);
            wrapper.appendChild(content);
            chatBox.appendChild(wrapper);
            
            lucide.createIcons();
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        // --- CORE ACTION: SEND MESSAGE ---
        window.sendMessage = async function() {
            if (isProcessing) return;
            
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const media = currentMedia;
            
            if (!text && !media) return;
            
            input.value = '';
            input.style.height = 'auto';
            clearMedia();
            
            appendMessage('user', text, media);
            
            isProcessing = true;
            document.getElementById('loader').classList.remove('hidden');
            setLoaderText('–ñ–∞—É–∞–ø –∂–∞–∑—ã–ª—É–¥–∞...');
            document.getElementById('send-btn').disabled = true;
            document.getElementById('send-btn').classList.add('opacity-50');

            try {
                if (!chat) initChat();

                let messageParts = [];
                if (text) messageParts.push({ text: text });
                
                if (media) {
                    messageParts.push({
                        inlineData: {
                            mimeType: media.mimeType,
                            data: media.data
                        }
                    });
                    if (!text) {
                        if (media.type === 'audio') {
                            messageParts.push({ text: "Listen to this audio carefully, transcribe it verbatim, and then answer the user's question or request inside it." });
                        } else if (media.type === 'image') {
                            messageParts.push({ text: "Analyze this image and explain what you see in an educational context." });
                        }
                    }
                }

                // 1. Send Request
                // Note: In @google/genai, sendMessage returns the response object directly
                const response = await chat.sendMessage({ message: messageParts });

                // 2. Check for Function Calls (Image Generation)
                // Note: Access as property (.functionCalls) not method (.functionCalls())
                const functionCalls = response.functionCalls;
                
                if (functionCalls && functionCalls.length > 0) {
                    for (const call of functionCalls) {
                        if (call.name === "generate_image") {
                            const prompt = call.args.prompt;
                            await handleImageGeneration(prompt, call.id);
                        }
                    }
                } else {
                    // Normal text response
                    // Note: Access as property (.text) not method (.text())
                    const responseText = response.text;
                    if (responseText) {
                        appendMessage('model', responseText);
                    }
                }

            } catch (err) {
                console.error("Generate Error:", err);
                appendSystemMessage(`<b>“ö–∞—Ç–µ:</b> ${err.message || '–ë–µ–ª–≥—ñ—Å—ñ–∑ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã.'}`);
            } finally {
                isProcessing = false;
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('send-btn').disabled = false;
                document.getElementById('send-btn').classList.remove('opacity-50');
                if (window.innerWidth > 768) document.getElementById('user-input').focus();
            }
        };

        // --- SEPARATE FUNCTION: HANDLE IMAGE GEN ---
        async function handleImageGeneration(prompt, callId) {
            setLoaderText('–°—É—Ä–µ—Ç —Å–∞–ª—ã–Ω—É–¥–∞...');
            try {
                // Call dedicated image model
                const response = await ai.models.generateContent({
                    model: IMAGE_MODEL_NAME,
                    contents: {
                        parts: [{ text: prompt }]
                    }
                });

                // Extract image
                let generatedImage = null;
                // Iterate through parts to find the inline image data
                if (response.candidates && response.candidates[0].content.parts) {
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData) {
                            generatedImage = {
                                type: 'image',
                                data: part.inlineData.data,
                                url: `data:image/png;base64,${part.inlineData.data}`,
                                mimeType: 'image/png'
                            };
                            break;
                        }
                    }
                }

                if (generatedImage) {
                    appendMessage('model', `–ú—ñ–Ω–µ, "${prompt}" –±–æ–π—ã–Ω—à–∞ –¥–∞–π—ã–Ω–¥–∞–ª“ì–∞–Ω —Å—É—Ä–µ—Ç:`, generatedImage, true);
                    
                    // Respond to chat tool
                    // Send function response as a tool response part in the message
                    await chat.sendMessage({
                        message: [{
                            functionResponse: {
                                name: "generate_image",
                                response: { result: "Image generated and displayed successfully." },
                                id: callId
                            }
                        }]
                    });
                } else {
                    appendMessage('model', "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, —Å—É—Ä–µ—Ç—Ç—ñ —Å–∞–ª–∞ –∞–ª–º–∞–¥—ã–º. “ö–∞–π—Ç–∞ –∫”©—Ä—ñ“£—ñ–∑—à—ñ.");
                    // Still need to close the function call loop
                    await chat.sendMessage({
                        message: [{
                            functionResponse: {
                                name: "generate_image",
                                response: { result: "Failed to generate image." },
                                id: callId
                            }
                        }]
                    });
                }

            } catch (e) {
                console.error("Image Gen Error", e);
                appendMessage('model', "–°—É—Ä–µ—Ç —Å–∞–ª—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã.");
            }
        }

        // --- MEDIA HANDLERS ---
        window.handleFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert("–¢–µ–∫ —Å—É—Ä–µ—Ç —Ñ–∞–π–ª–¥–∞—Ä—ã–Ω –∂“Ø–∫—Ç–µ—É–≥–µ –±–æ–ª–∞–¥—ã.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                currentMedia = {
                    type: 'image',
                    data: base64,
                    mimeType: file.type,
                    url: e.target.result
                };
                updateMediaPreview();
            };
            reader.readAsDataURL(file);
            input.value = '';
        };

        window.startRecording = async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                let mimeType = 'audio/webm'; 
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mimeType = 'audio/webm;codecs=opus';
                else if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                let chunks = [];
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mimeType });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64 = e.target.result.split(',')[1];
                        currentMedia = {
                            type: 'audio',
                            data: base64,
                            mimeType: mimeType,
                            url: e.target.result
                        };
                        updateMediaPreview();
                    };
                    reader.readAsDataURL(blob);
                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.start();
                document.getElementById('input-controls').classList.add('hidden');
                document.getElementById('recording-status').classList.remove('hidden');
                document.getElementById('recording-status').classList.add('flex');
                
                let seconds = 0;
                const timerEl = document.getElementById('recording-time');
                timerEl.innerText = "0:00";
                recordingInterval = setInterval(() => {
                    seconds++;
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    timerEl.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                }, 1000);
            } catch (err) {
                console.error(err);
                alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω“ì–∞ —Ä“±“õ—Å–∞—Ç –±–µ—Ä—ñ–ª–º–µ–¥—ñ.");
            }
        };

        window.stopRecording = function() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                document.getElementById('recording-status').classList.add('hidden');
                document.getElementById('recording-status').classList.remove('flex');
                document.getElementById('input-controls').classList.remove('hidden');
            }
        };

        window.clearMedia = function() {
            currentMedia = null;
            updateMediaPreview();
        };

        function updateMediaPreview() {
            const previewBox = document.getElementById('media-preview');
            const img = document.getElementById('preview-img');
            const audio = document.getElementById('preview-audio');
            const label = document.getElementById('media-type-label');
            
            if (!currentMedia) {
                previewBox.classList.remove('flex');
                previewBox.classList.add('hidden');
                return;
            }
            previewBox.classList.remove('hidden');
            previewBox.classList.add('flex');
            if (currentMedia.type === 'image') {
                img.src = currentMedia.url;
                img.classList.remove('hidden');
                audio.classList.add('hidden');
                label.innerText = "–°—É—Ä–µ—Ç";
            } else {
                img.classList.add('hidden');
                audio.classList.remove('hidden');
                label.innerText = "–ê—É–¥–∏–æ";
            }
        }
    </script>
</body>
</html>
