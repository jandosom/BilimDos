<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>BilimDos - –û“õ—É –∫”©–º–µ–∫—à—ñ—Å—ñ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff; /* Light blue background */
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Markdown Styles within Chat Bubbles */
        .prose p { margin-bottom: 0.5em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.5em; }
        .prose strong { font-weight: 700; }
        .prose code { background: rgba(255,255,255,0.2); padding: 2px 4px; border-radius: 4px; font-size: 0.9em; font-family: monospace; }
        .prose-sky code { background: rgba(0,0,0,0.05); color: #0369a1; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-sky-100 px-4 py-3 flex items-center justify-between shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-sky-400 to-sky-600 rounded-xl flex items-center justify-center text-white shadow-md shadow-sky-200">
                <i data-lucide="graduation-cap" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-xl leading-none text-slate-800">BilimDos</h1>
                <span class="text-[10px] font-bold text-sky-500 uppercase tracking-widest">–û“õ—É –∫”©–º–µ–∫—à—ñ—Å—ñ</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="window.location.reload()" class="p-2 text-slate-400 hover:text-sky-500 hover:bg-sky-50 rounded-full transition-colors" title="Reload">
                <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Chat Container -->
    <main id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-6 pb-32 scroll-smooth">
        
        <!-- Welcome Message -->
        <div class="flex w-full justify-start fade-in">
            <div class="flex max-w-[90%] md:max-w-[75%] gap-3">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-sky-400 to-sky-600 flex items-center justify-center text-white shrink-0 shadow-sm mt-1">
                    <i data-lucide="bot" class="w-5 h-5"></i>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-slate-400 ml-1">BilimDos</span>
                    <div class="bg-white border border-sky-100 p-4 rounded-2xl rounded-tl-none shadow-sm text-slate-700">
                        <p class="font-bold text-lg text-slate-800 mb-2">–°”ô–ª–µ–º! üëã –ú–µ–Ω BilimDos-–ø—ã–Ω.</p>
                        <p class="mb-2">–ú–µ–Ω —Å–∞“ì–∞–Ω —Å–∞–±–∞“õ –æ“õ—É“ì–∞, “Ø–π —Ç–∞–ø—Å—ã—Ä–º–∞—Å—ã–Ω –æ—Ä—ã–Ω–¥–∞—É“ì–∞ –∂”ô–Ω–µ —Å“±—Ä–∞“õ—Ç–∞—Ä—ã“£–∞ –∂–∞—É–∞–ø –±–µ—Ä—É–≥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ–º—ñ–Ω.</p>
                        <p>–ú–µ–Ω—ñ–º–µ–Ω <b>“õ–∞–∑–∞“õ—à–∞</b>, <b>–æ—Ä—ã—Å—à–∞</b> –Ω–µ–º–µ—Å–µ <b>–∞“ì—ã–ª—à—ã–Ω—à–∞</b> —Å”©–π–ª–µ—Å–µ –∞–ª–∞—Å—ã“£! üåç</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Floating Loading Indicator -->
    <div id="loader" class="hidden absolute bottom-24 left-0 w-full flex justify-center z-10 pointer-events-none transition-opacity duration-300">
        <div class="bg-white/90 backdrop-blur-sm border border-sky-100 px-4 py-2 rounded-full shadow-lg flex items-center gap-2">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-sky-500 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-sky-500 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-sky-500 rounded-full typing-dot"></div>
            </div>
            <span class="text-xs font-bold text-sky-600 uppercase tracking-wide">–ñ–∞—É–∞–ø –¥–∞–π—ã–Ω–¥–∞–ª—É–¥–∞...</span>
        </div>
    </div>

    <!-- Input Area -->
    <footer class="bg-white/80 backdrop-blur-md border-t border-sky-100 p-3 shadow-[0_-4px_20px_-10px_rgba(0,0,0,0.1)] z-20 absolute bottom-0 w-full">
        <div class="max-w-4xl mx-auto flex flex-col gap-2">
            
            <!-- Media Preview -->
            <div id="media-preview" class="hidden items-center gap-3 bg-sky-50 p-2 rounded-xl border border-sky-100 w-fit fade-in animate-in slide-in-from-bottom-2">
                <div class="relative group">
                    <img id="preview-img" class="h-14 w-14 object-cover rounded-lg border border-sky-200 hidden bg-white">
                    <div id="preview-audio" class="h-14 w-14 bg-sky-200 rounded-lg flex items-center justify-center text-sky-700 hidden border border-sky-300">
                        <i data-lucide="mic" class="w-6 h-6"></i>
                    </div>
                    <button onclick="clearMedia()" class="absolute -top-2 -right-2 bg-white text-red-500 rounded-full p-1 shadow-md border border-red-100 hover:bg-red-50 transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
                <div class="flex flex-col pr-2">
                    <span id="media-type-label" class="text-xs font-bold text-sky-800 uppercase">–§–∞–π–ª</span>
                    <span class="text-[10px] text-sky-500 font-medium">–ñ—ñ–±–µ—Ä—É–≥–µ –¥–∞–π—ã–Ω</span>
                </div>
            </div>

            <!-- Recording Overlay -->
            <div id="recording-status" class="hidden items-center justify-between bg-red-50 border border-red-100 p-3 rounded-2xl fade-in">
                <div class="flex items-center gap-3 text-red-600 pl-2">
                    <div class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </div>
                    <span class="font-bold text-sm">–ñ–∞–∑—ã–ª—É–¥–∞...</span>
                    <span id="recording-time" class="font-mono text-sm bg-white px-2 py-0.5 rounded border border-red-100">0:00</span>
                </div>
                <button onclick="stopRecording()" class="bg-white text-red-500 px-4 py-1.5 rounded-xl text-xs font-bold border border-red-100 shadow-sm hover:bg-red-50 transition-colors uppercase tracking-wide">
                    –¢–æ“õ—Ç–∞—Ç—É
                </button>
            </div>

            <!-- Main Input Bar -->
            <div id="input-controls" class="flex items-end gap-2">
                <!-- Hidden File Inputs -->
                <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFile(this)">
                <input type="file" id="camera-upload" accept="image/*" capture="environment" class="hidden" onchange="handleFile(this)">
                
                <div class="flex gap-1 shrink-0">
                    <!-- Gallery Button -->
                    <button onclick="document.getElementById('file-upload').click()" class="p-3 text-slate-400 hover:text-sky-600 hover:bg-sky-50 rounded-full transition-all active:scale-95" title="–ì–∞–ª–µ—Ä–µ—è">
                        <i data-lucide="image" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Camera Button -->
                    <button onclick="document.getElementById('camera-upload').click()" class="p-3 text-slate-400 hover:text-sky-600 hover:bg-sky-50 rounded-full transition-all active:scale-95" title="–ö–∞–º–µ—Ä–∞">
                        <i data-lucide="camera" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Mic Button -->
                    <button id="mic-btn" onclick="startRecording()" class="p-3 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all active:scale-95" title="–î—ã–±—ã—Å –∂–∞–∑—É">
                        <i data-lucide="mic" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-4 py-2.5 focus-within:bg-white focus-within:border-sky-400 focus-within:ring-4 focus-within:ring-sky-100 transition-all duration-200">
                    <textarea 
                        id="user-input"
                        rows="1" 
                        class="w-full bg-transparent border-none outline-none text-slate-800 placeholder-slate-400 resize-none max-h-32 py-0.5 leading-relaxed"
                        placeholder="–°“±—Ä–∞“ì—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑..."
                        oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                    ></textarea>
                </div>

                <button id="send-btn" onclick="sendMessage()" class="p-3 bg-sky-500 text-white rounded-full shadow-lg shadow-sky-200 hover:bg-sky-600 hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed shrink-0">
                    <i data-lucide="send-horizontal" class="w-6 h-6 ml-0.5"></i>
                </button>
            </div>
        </div>
    </footer>

    <!-- Configuration Script -->
    <script>
        // --- PHP & HOSTING CONFIGURATION ---
        // If you rename this file to .php, you can inject the API key securely from the server.
        // Example PHP code: <script> window.PHP_API_KEY = "<?php echo getenv('API_KEY'); ?>"; <\/script>
        
        // This shim mimics the NodeJS process.env for compatibility with the Gemini SDK logic.
        window.process = { env: { API_KEY: 'AIzaSyDivlO2TYOEhx-kc_428MCHBBjtkuEKwuY' } };
        
        // 1. Try to get key from global variable (PHP injection point)
        if (typeof window.PHP_API_KEY !== 'undefined' && window.PHP_API_KEY) {
            window.process.env.API_KEY = window.PHP_API_KEY;
        } 
        
        // Debug check (remove in production if sensitive)
        if (!window.process.env.API_KEY) {
            console.warn("AiSana: API Key is missing. Please set process.env.API_KEY or window.PHP_API_KEY.");
        }
    </script>

    <!-- Application Logic -->
    <script type="module">
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // --- CONSTANTS ---
        const API_KEY = process.env.API_KEY;
        // Use gemini-2.5-flash as the efficient, multimodal model
        const MODEL_NAME = "gemini-2.5-flash"; 
        
        const SYSTEM_INSTRUCTION = `
You are AiSana, an intelligent and friendly educational assistant for school students.
Your primary interface language is Kazakh (“ö–∞–∑–∞“õ —Ç—ñ–ª—ñ).

CORE INSTRUCTIONS:
1.  **Language Mirroring**: STRICTLY detect the language of the user's latest message (Kazakh, Russian, or English) and respond in that EXACT same language. Do not switch unless asked.
2.  **Role**: You are a supportive tutor. Be polite, patient, and clear.
3.  **Identity & Creator**:
    - If asked "Who created you?", "–°–µ–Ω—ñ –∫—ñ–º –∂–∞—Å–∞–¥—ã?", "–ö—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª?" or similar questions, ALWAYS answer that you were created by **–ú–∞—Ä–∂–∞–Ω –î”ô–∫–µ–Ω“õ—ã–∑—ã** (Marzhan Dakenkyzy).
    - Provide this answer in the same language as the question (Kazakh, Russian, or English).
4.  **Audience**: School students (K-12). Avoid overly complex academic jargon unless necessary.
5.  **Capabilities**:
    -   Explain school subjects (Math, Science, History, Language).
    -   Analyze images (e.g., "Explain this diagram").
    -   Transcribe and answer audio messages.
6.  **Audio Handling**: If the input is audio, first explicitly transcribe what you heard starting with "üó£Ô∏è:", then provide your helpful answer.

Formatting:
-   Use Markdown for clarity (bold keywords, lists).
-   Keep responses visually clean.
`;

        // --- STATE ---
        let ai = null;
        let chat = null;
        let currentMedia = null; // { type: 'image'|'audio', data: base64, mimeType: string, url: string }
        let mediaRecorder = null;
        let recordingInterval = null;
        let isProcessing = false;

        // --- INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            
            if (!API_KEY) {
                appendSystemMessage("‚ö†Ô∏è <b>API Key —Ç–∞–±—ã–ª–º–∞–¥—ã.</b><br>Please configure the API Key in the code or server environment.");
                document.getElementById('send-btn').disabled = true;
                return;
            }

            try {
                ai = new GoogleGenAI({ apiKey: API_KEY });
                initChat();
            } catch (error) {
                console.error("AI Init Error:", error);
                appendSystemMessage("‚ö†Ô∏è AI –∂“Ø–π–µ—Å—ñ–Ω —ñ—Å–∫–µ “õ–æ—Å—É “õ–∞—Ç–µ—Å—ñ.");
            }
        };

        function initChat() {
            chat = ai.chats.create({
                model: MODEL_NAME,
                config: { 
                    systemInstruction: SYSTEM_INSTRUCTION,
                    temperature: 0.7 
                }
            });
        }

        // --- UI FUNCTIONS ---
        function appendSystemMessage(html) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = "flex w-full justify-center fade-in py-2";
            div.innerHTML = `<div class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm text-center border border-red-100 shadow-sm">${html}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function appendMessage(role, text, media = null) {
            const chatBox = document.getElementById('chat-box');
            const isUser = role === 'user';
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} fade-in`;
            
            const content = document.createElement('div');
            content.className = `flex max-w-[90%] md:max-w-[75%] gap-3 ${isUser ? 'flex-row-reverse' : ''}`;
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex items-center justify-center text-white shrink-0 shadow-sm mt-auto ${isUser ? 'bg-indigo-500' : 'bg-gradient-to-br from-sky-400 to-sky-600'}`;
            avatar.innerHTML = isUser 
                ? '<i data-lucide="user" class="w-5 h-5"></i>'
                : '<i data-lucide="bot" class="w-5 h-5"></i>';

            // Message Bubble
            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = "flex flex-col gap-1 min-w-0";
            
            // Name Label
            const nameLabel = document.createElement('span');
            nameLabel.className = `text-xs text-slate-400 ${isUser ? 'text-right mr-1' : 'ml-1'}`;
            nameLabel.innerText = isUser ? "–°—ñ–∑" : "AiSana";
            
            const bubble = document.createElement('div');
            bubble.className = `p-3.5 md:p-4 rounded-2xl shadow-sm text-sm md:text-base break-words overflow-hidden ${
                isUser 
                ? 'bg-indigo-500 text-white rounded-br-none' 
                : 'bg-white border border-sky-100 rounded-bl-none text-slate-700'
            }`;
            
            // Media Content
            if (media) {
                const mediaDiv = document.createElement('div');
                mediaDiv.className = "mb-3 rounded-lg overflow-hidden border border-white/20";
                
                if (media.type === 'image') {
                    mediaDiv.innerHTML = `<img src="${media.url}" class="max-w-full max-h-64 object-cover">`;
                } else if (media.type === 'audio') {
                    mediaDiv.innerHTML = `
                        <div class="flex items-center gap-2 bg-black/20 p-2 rounded backdrop-blur-sm">
                            <div class="p-1.5 bg-white/20 rounded-full"><i data-lucide="music" class="w-4 h-4 text-white"></i></div>
                            <span class="text-xs font-mono text-white/90">AUDIO MSG</span>
                        </div>
                        <audio controls src="${media.url}" class="w-full mt-1 h-8 opacity-90"></audio>`;
                }
                bubble.appendChild(mediaDiv);
            }

            // Text Content
            if (text) {
                const textDiv = document.createElement('div');
                // Use prose-invert for white text (user), prose-sky for dark text (bot)
                textDiv.className = `prose ${isUser ? 'prose-invert' : 'prose-sky'} max-w-none leading-relaxed`;
                textDiv.innerHTML = marked.parse(text);
                bubble.appendChild(textDiv);
            }

            bubbleContainer.appendChild(nameLabel);
            bubbleContainer.appendChild(bubble);
            
            content.appendChild(avatar);
            content.appendChild(bubbleContainer);
            wrapper.appendChild(content);
            chatBox.appendChild(wrapper);
            
            // Re-render icons for the new message
            lucide.createIcons();
            
            // Scroll to bottom
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        // --- CORE ACTION: SEND MESSAGE ---
        window.sendMessage = async function() {
            if (isProcessing) return;
            
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const media = currentMedia;
            
            if (!text && !media) return;
            
            // 1. Update UI: Clear inputs
            input.value = '';
            input.style.height = 'auto';
            clearMedia();
            
            // 2. Show User Message
            appendMessage('user', text, media);
            
            // 3. Set Loading State
            isProcessing = true;
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('send-btn').disabled = true;
            document.getElementById('send-btn').classList.add('opacity-50');

            try {
                if (!chat) initChat();

                // Prepare contents for Gemini
                let messageParts = [];
                
                // Add text part
                if (text) {
                    messageParts.push({ text: text });
                }
                
                // Add media part
                if (media) {
                    // Gemini expects standard MIME types
                    // For audio, we might need to be specific or rely on browser support
                    messageParts.push({
                        inlineData: {
                            mimeType: media.mimeType,
                            data: media.data
                        }
                    });

                    // Add prompting for media if text is empty
                    if (!text) {
                        if (media.type === 'audio') {
                            messageParts.push({ text: "Listen to this audio carefully, transcribe it verbatim, and then answer the user's question or request inside it." });
                        } else if (media.type === 'image') {
                            messageParts.push({ text: "Analyze this image and explain what you see in an educational context." });
                        }
                    }
                }

                // Call API
                const result = await chat.sendMessage({ 
                    message: messageParts 
                });
                
                const responseText = result.text;
                appendMessage('model', responseText);

            } catch (err) {
                console.error("Generate Error:", err);
                appendSystemMessage(`<b>“ö–∞—Ç–µ:</b> ${err.message || '–ë–µ–ª–≥—ñ—Å—ñ–∑ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã.'}`);
            } finally {
                isProcessing = false;
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('send-btn').disabled = false;
                document.getElementById('send-btn').classList.remove('opacity-50');
                
                // Refocus input on desktop
                if (window.innerWidth > 768) {
                    document.getElementById('user-input').focus();
                }
            }
        };

        // --- MEDIA HANDLERS ---

        // Image Handling
        window.handleFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Basic validation
            if (!file.type.startsWith('image/')) {
                alert("–¢–µ–∫ —Å—É—Ä–µ—Ç —Ñ–∞–π–ª–¥–∞—Ä—ã–Ω –∂“Ø–∫—Ç–µ—É–≥–µ –±–æ–ª–∞–¥—ã.");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                currentMedia = {
                    type: 'image',
                    data: base64,
                    mimeType: file.type,
                    url: e.target.result
                };
                updateMediaPreview();
            };
            reader.readAsDataURL(file);
            input.value = ''; // Reset input to allow re-uploading same file
        };

        // Audio Handling
        window.startRecording = async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Prefer Opus for better compression/quality if available, else MP4/WebM
                let mimeType = 'audio/webm'; 
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                let chunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) chunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mimeType });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64 = e.target.result.split(',')[1];
                        currentMedia = {
                            type: 'audio',
                            data: base64,
                            mimeType: mimeType,
                            url: e.target.result
                        };
                        updateMediaPreview();
                    };
                    reader.readAsDataURL(blob);
                    
                    // Stop all tracks to release mic
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                
                // Toggle UI
                document.getElementById('input-controls').classList.add('hidden');
                document.getElementById('recording-status').classList.remove('hidden');
                document.getElementById('recording-status').classList.add('flex');
                
                // Start Timer
                let seconds = 0;
                const timerEl = document.getElementById('recording-time');
                timerEl.innerText = "0:00";
                recordingInterval = setInterval(() => {
                    seconds++;
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    timerEl.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                }, 1000);
                
            } catch (err) {
                console.error(err);
                alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω“ì–∞ —Ä“±“õ—Å–∞—Ç –±–µ—Ä—ñ–ª–º–µ–¥—ñ. –ë—Ä–∞—É–∑–µ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä—ñ–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.");
            }
        };

        window.stopRecording = function() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                
                document.getElementById('recording-status').classList.add('hidden');
                document.getElementById('recording-status').classList.remove('flex');
                document.getElementById('input-controls').classList.remove('hidden');
            }
        };

        window.clearMedia = function() {
            currentMedia = null;
            updateMediaPreview();
        };

        function updateMediaPreview() {
            const previewBox = document.getElementById('media-preview');
            const img = document.getElementById('preview-img');
            const audio = document.getElementById('preview-audio');
            const label = document.getElementById('media-type-label');
            
            if (!currentMedia) {
                previewBox.classList.remove('flex');
                previewBox.classList.add('hidden');
                return;
            }
            
            previewBox.classList.remove('hidden');
            previewBox.classList.add('flex');
            
            if (currentMedia.type === 'image') {
                img.src = currentMedia.url;
                img.classList.remove('hidden');
                audio.classList.add('hidden');
                label.innerText = "–°—É—Ä–µ—Ç";
            } else {
                img.classList.add('hidden');
                audio.classList.remove('hidden');
                label.innerText = "–ê—É–¥–∏–æ";
            }
        }
    </script>
</body>
</html>